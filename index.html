<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Neon Bros: Pro Controller Fix</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');

        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Orbitron', sans-serif; }
        canvas { display: block; }
        
        /* --- TUŞ İKONLARI --- */
        .btn {
            display: inline-flex; justify-content: center; align-items: center;
            width: 28px; height: 28px; border-radius: 50%; 
            margin: 0 5px; position: relative; vertical-align: middle;
            box-shadow: 0 3px 0 rgba(0,0,0,0.5); font-family: Arial, sans-serif; font-weight: bold;
        }

        /* Xbox Stili */
        .xbox-a { background: #1a1a1a; color: greenyellow; border: 2px solid #414040; font-size: 16px; }
        .xbox-x { background: #1a1a1a; color: rgb(27, 109, 216); border: 2px solid #414040; font-size: 16px; }

        /* PlayStation Stili */
        .ps-cross { background: #1a1a1a; border: 2px solid #414040; }
        .ps-cross::after { content: '✕'; color: #4b8ac4; font-size: 16px; font-weight: bold; }

        .ps-square { background: #1a1a1a; border: 2px solid #414040; }
        .ps-square::after { 
            content: ''; display: block; width: 10px; height: 10px; 
            border: 3px solid #d856ac; /* Pembe Kare */
            border-radius: 2px;
        }

        /* --- UI KATMANI --- */
        #ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
        }

        .top-bar { display: flex; justify-content: space-between; padding: 20px 50px; text-shadow: 0 0 10px currentColor; font-size: 24px; font-weight: bold; }
        #p1-score { color: #00f7ff; }
        #p2-score { color: #ffaa00; }

        .bottom-bar { display: flex; justify-content: space-between; padding: 20px 50px; align-items: end; }
        .ulti-container { width: 300px; text-align: left; opacity: 0.9; }
        .ulti-label { color: white; font-size: 14px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .ulti-bar-bg { width: 100%; height: 12px; background: #222; border: 2px solid #444; border-radius: 6px; overflow: hidden; }
        .ulti-bar-fill { height: 100%; width: 0%; transition: width 0.1s linear; box-shadow: 0 0 15px currentColor; }
        
        /* BAŞLANGIÇ EKRANI */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(10,10,20,0.98) 0%, #000 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; z-index: 10; pointer-events: auto;
        }
        
        h1 { 
            font-size: 70px; margin: 0; letter-spacing: 5px; 
            background: linear-gradient(to right, #00f7ff, #ffffff, #ffaa00);
            -webkit-background-clip: text; color: transparent;
            text-shadow: 0 0 30px rgba(255,255,255,0.3);
        }

        .status-area { margin-top: 50px; display: flex; gap: 40px; }
        .player-card {
            background: rgba(255,255,255,0.05); padding: 20px 40px; border-radius: 10px; border: 1px solid #333;
            text-align: center; width: 200px; transition: 0.3s;
        }
        .player-card.active { border-color: #00f7ff; background: rgba(0, 247, 255, 0.05); box-shadow: 0 0 20px rgba(0, 247, 255, 0.1); }
        .player-card.active-p2 { border-color: #ffaa00; background: rgba(255, 170, 0, 0.05); box-shadow: 0 0 20px rgba(255, 170, 0, 0.1); }
        
        .con-name { font-size: 12px; color: #888; margin-top: 5px; }
        .start-prompt { margin-top: 15px; font-size: 14px; opacity: 0; transition: 0.3s; }
        .start-prompt.show { opacity: 1; }

    </style>
</head>
<body>

    <div id="ui">
        <div class="top-bar">
            <span id="p1-score">P1: 0</span>
            <span id="p2-score">P2: 0</span>
        </div>
        
        <div class="bottom-bar">
            <div class="ulti-container">
                <div class="ulti-label">
                    <span id="p1-ulti-icon" class="btn"></span> ULTİ
                    <span id="p1-ulti-text" style="color:#00f7ff; font-size:10px; margin-left:auto;">HAZIR!</span>
                </div>
                <div class="ulti-bar-bg"><div id="p1-ulti-bar" class="ulti-bar-fill" style="background:#00f7ff; width:100%;"></div></div>
            </div>

            <div class="ulti-container" style="text-align:right;">
                <div class="ulti-label" style="justify-content: flex-end;">
                    <span id="p2-ulti-text" style="color:#ffaa00; font-size:10px; margin-right:auto;">HAZIR!</span>
                    ULTİ <span id="p2-ulti-icon" class="btn"></span>
                </div>
                <div class="ulti-bar-bg"><div id="p2-ulti-bar" class="ulti-bar-fill" style="background:#ffaa00; width:100%;"></div></div>
            </div>
        </div>
    </div>

    <div id="start-screen">
        <h1>NEON BROS</h1>
        <div style="font-size: 14px; letter-spacing: 5px; color: #666; margin-bottom: 40px;">PRO CONTROLLER SUPPORT</div>

        <div class="status-area">
            <div id="p1-card" class="player-card">
                <div style="font-size:20px; font-weight:bold; color:#00f7ff;">OYUNCU 1</div>
                <div id="p1-con-name" class="con-name">KOL BEKLENİYOR...</div>
                <div id="p1-prompt" class="start-prompt">
                    <span id="p1-start-icon" class="btn"></span> BAS
                </div>
            </div>

            <div id="p2-card" class="player-card">
                <div style="font-size:20px; font-weight:bold; color:#ffaa00;">OYUNCU 2</div>
                <div id="p2-con-name" class="con-name">KOL BEKLENİYOR...</div>
                <div id="p2-prompt" class="start-prompt">
                    <span id="p2-start-icon" class="btn"></span> BAS
                </div>
            </div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // --- HTML ELEMENTLERİ ---
    const uiElements = {
        p1: {
            card: document.getElementById('p1-card'),
            name: document.getElementById('p1-con-name'),
            prompt: document.getElementById('p1-prompt'),
            startIcon: document.getElementById('p1-start-icon'),
            ultiIcon: document.getElementById('p1-ulti-icon'),
            ultiBar: document.getElementById('p1-ulti-bar'),
            ultiText: document.getElementById('p1-ulti-text'),
            score: document.getElementById('p1-score')
        },
        p2: {
            card: document.getElementById('p2-card'),
            name: document.getElementById('p2-con-name'),
            prompt: document.getElementById('p2-prompt'),
            startIcon: document.getElementById('p2-start-icon'),
            ultiIcon: document.getElementById('p2-ulti-icon'),
            ultiBar: document.getElementById('p2-ulti-bar'),
            ultiText: document.getElementById('p2-ulti-text'),
            score: document.getElementById('p2-score')
        },
        startScreen: document.getElementById('start-screen')
    };

    // --- AYARLAR ---
    const P1_COLOR = '#00f7ff';
    const P2_COLOR = '#ffaa00';
    let gameActive = false;
    let shakeTime = 0;

    // --- KOL TÜRÜ ALGILAMA ---
    function getControllerType(gamepad) {
        if (!gamepad) return 'xbox';
        const id = gamepad.id.toLowerCase();
        if (id.includes('sony') || id.includes('dual') || id.includes('054c') || id.includes('playstation')) {
            return 'ps';
        }
        return 'xbox';
    }

    function updateIcons(playerId, type) {
        const p = playerId === 0 ? uiElements.p1 : uiElements.p2;
        
        // Sınıfları ve İÇERİĞİ Temizle (Düzeltme Burası)
        p.startIcon.className = 'btn';
        p.startIcon.innerText = ''; 
        
        p.ultiIcon.className = 'btn';
        p.ultiIcon.innerText = ''; 

        if (type === 'ps') {
            // PS İkonları
            p.startIcon.classList.add('ps-cross');
            p.ultiIcon.classList.add('ps-square'); // Kare ikonu
        } else {
            // Xbox İkonları
            p.startIcon.classList.add('xbox-a');
            p.startIcon.innerText = 'A';
            p.ultiIcon.classList.add('xbox-x');
            p.ultiIcon.innerText = 'X';
        }
    }

    // --- OYUN SINIFLARI ---
    class Shockwave {
        constructor(x, y, color) {
            this.x = x; this.y = y; this.color = color;
            this.radius = 10; this.maxRadius = 400; this.speed = 15;
            this.active = true; this.lineWidth = 10; this.alpha = 1;
        }
        update() {
            this.radius += this.speed; this.lineWidth *= 0.95; this.alpha -= 0.03;
            if (this.alpha <= 0) this.active = false;
            enemies.forEach((e, index) => {
                if (Math.abs(Math.hypot(e.x - this.x, e.y - this.y) - this.radius) < 30) {
                    createExplosion(e.x, e.y, e.color); enemies.splice(index, 1);
                }
            });
        }
        draw() {
            ctx.save(); ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
            ctx.strokeStyle = this.color; ctx.lineWidth = this.lineWidth; ctx.globalAlpha = this.alpha;
            ctx.shadowBlur = 20; ctx.shadowColor = this.color; ctx.stroke(); ctx.restore();
        }
    }

    class Player {
        constructor(id, color) {
            this.id = id; this.color = color;
            this.x = canvas.width/2 + (id===0?-100:100); this.y = canvas.height/2;
            this.radius = 20; this.speed = 6; this.lives = 2; 
            this.isDead = false; this.invulnerableTime = 0; this.reviveProgress = 0;
            this.score = 0; this.lastShot = 0; this.fireRate = 100; this.aimAngle = 0;
            this.lastUlti = 0; this.ultiCooldown = 20000;
        }

        update(gamepad) {
            if (this.isDead) return;
            if (this.invulnerableTime > 0) this.invulnerableTime--;

            this.x += (Math.abs(gamepad.axes[0])>0.1 ? gamepad.axes[0] : 0) * this.speed;
            this.y += (Math.abs(gamepad.axes[1])>0.1 ? gamepad.axes[1] : 0) * this.speed;
            this.constrain();

            let ax = Math.abs(gamepad.axes[2])>0.1 ? gamepad.axes[2] : 0;
            let ay = Math.abs(gamepad.axes[3])>0.1 ? gamepad.axes[3] : 0;
            if(ax!==0 || ay!==0) {
                this.aimAngle = Math.atan2(ay, ax);
                if(Date.now() - this.lastShot > this.fireRate) {
                    bullets.push(new Bullet(this.x, this.y, this.aimAngle, this.color));
                    this.lastShot = Date.now();
                    this.x -= Math.cos(this.aimAngle)*2; this.y -= Math.sin(this.aimAngle)*2;
                }
            }

            if(gamepad.buttons[2].pressed) this.triggerUlti();
            this.updateUI();
        }

        triggerUlti() {
            if(Date.now() - this.lastUlti > this.ultiCooldown) {
                this.lastUlti = Date.now();
                shockwaves.push(new Shockwave(this.x, this.y, this.color));
                shakeTime = 30;
            }
        }

        updateUI() {
            let timePassed = Date.now() - this.lastUlti;
            let percent = Math.min((timePassed/this.ultiCooldown)*100, 100);
            if(this.lastUlti === 0) percent = 100;

            const pUI = this.id===0 ? uiElements.p1 : uiElements.p2;
            pUI.ultiBar.style.width = percent + "%";
            if(percent >= 100) {
                pUI.ultiBar.style.backgroundColor = this.color;
                pUI.ultiBar.style.boxShadow = `0 0 10px ${this.color}`;
                pUI.ultiText.innerText = "HAZIR!"; pUI.ultiText.style.opacity = 1;
            } else {
                pUI.ultiBar.style.backgroundColor = "#555"; pUI.ultiBar.style.boxShadow = "none";
                pUI.ultiText.innerText = Math.ceil((this.ultiCooldown-timePassed)/1000) + "sn";
                pUI.ultiText.style.opacity = 0.5;
            }
        }

        constrain() {
            if(this.x<this.radius) this.x=this.radius; if(this.x>canvas.width-this.radius) this.x=canvas.width-this.radius;
            if(this.y<this.radius) this.y=this.radius; if(this.y>canvas.height-this.radius) this.y=canvas.height-this.radius;
        }

        takeDamage() {
            if(this.invulnerableTime>0 || this.isDead) return;
            this.lives--; shakeTime=10;
            if(this.lives<=0) { this.isDead=true; createExplosion(this.x,this.y,this.color); }
            else { this.invulnerableTime=120; createExplosion(this.x,this.y,"#fff"); }
        }

        draw() {
            if(this.isDead) {
                ctx.save(); ctx.globalAlpha=0.3; ctx.strokeStyle=this.color; ctx.lineWidth=2;
                ctx.beginPath(); ctx.arc(this.x,this.y,this.radius,0,Math.PI*2); ctx.stroke();
                ctx.font="12px Orbitron"; ctx.fillStyle="white"; ctx.textAlign="center"; 
                ctx.fillText("KURTAR",this.x,this.y-35);
                if(this.reviveProgress>0) { ctx.fillStyle="#00ff00"; ctx.fillRect(this.x-20,this.y+35,(this.reviveProgress/100)*40,5); }
                ctx.restore(); return;
            }
            if(this.invulnerableTime>0 && Math.floor(Date.now()/50)%2===0) return;
            ctx.save(); ctx.shadowBlur=15; ctx.shadowColor=this.color; ctx.fillStyle=this.color;
            ctx.beginPath(); ctx.arc(this.x,this.y,this.radius,0,Math.PI*2); ctx.fill();
            ctx.shadowBlur=0; ctx.strokeStyle="rgba(255,255,255,0.5)"; ctx.lineWidth=2;
            ctx.beginPath(); ctx.moveTo(this.x,this.y); 
            ctx.lineTo(this.x+Math.cos(this.aimAngle)*40, this.y+Math.sin(this.aimAngle)*40); ctx.stroke();
            ctx.font="14px Arial"; ctx.fillStyle="#ff3333"; ctx.textAlign="center";
            let hearts=""; for(let i=0;i<this.lives;i++) hearts+="❤"; ctx.fillText(hearts,this.x,this.y-30);
            ctx.fillStyle="#000"; ctx.font="bold 10px Orbitron"; ctx.textBaseline="middle"; 
            ctx.fillText(this.id===0?"P1":"P2",this.x,this.y); ctx.restore();
        }
    }

    class Bullet {
        constructor(x, y, a, c) { this.x=x+Math.cos(a)*20; this.y=y+Math.sin(a)*20; this.vx=Math.cos(a)*15; this.vy=Math.sin(a)*15; this.c=c; }
        update() { this.x+=this.vx; this.y+=this.vy; }
        draw() { ctx.save(); ctx.shadowBlur=10; ctx.shadowColor=this.c; ctx.fillStyle="white"; ctx.beginPath(); ctx.arc(this.x,this.y,4,0,Math.PI*2); ctx.fill(); ctx.restore(); }
    }
    class Enemy {
        constructor() { 
            if(Math.random()<0.5){this.x=Math.random()<0.5?-30:canvas.width+30;this.y=Math.random()*canvas.height;}
            else{this.x=Math.random()*canvas.width;this.y=Math.random()<0.5?-30:canvas.height+30;}
            this.r=15; this.s=Math.random()*2+1; this.c='#ff0044';
        }
        update() {
            let t=null, d1=players[0].isDead?Infinity:Math.hypot(players[0].x-this.x,players[0].y-this.y), d2=players[1].isDead?Infinity:Math.hypot(players[1].x-this.x,players[1].y-this.y);
            if(d1===Infinity && d2===Infinity) return;
            t=d1<d2?players[0]:players[1];
            let a=Math.atan2(t.y-this.y,t.x-this.x); this.x+=Math.cos(a)*this.s; this.y+=Math.sin(a)*this.s;
        }
        draw() { ctx.save(); ctx.shadowBlur=10; ctx.shadowColor=this.c; ctx.fillStyle=this.c; ctx.fillRect(this.x-this.r,this.y-this.r,this.r*2,this.r*2); ctx.restore(); }
    }
    class Particle {
        constructor(x,y,c) { this.x=x;this.y=y;this.vx=(Math.random()-0.5)*10;this.vy=(Math.random()-0.5)*10;this.life=1;this.c=c; }
        update() { this.x+=this.vx; this.y+=this.vy; this.life-=0.04; }
        draw() { ctx.save(); ctx.globalAlpha=this.life; ctx.fillStyle=this.c; ctx.beginPath(); ctx.arc(this.x,this.y,3,0,Math.PI*2); ctx.fill(); ctx.restore(); }
    }

    const players = [new Player(0, P1_COLOR), new Player(1, P2_COLOR)];
    let bullets=[], enemies=[], particles=[], shockwaves=[];
    let spawnTimer=0, spawnRate=50;

    function createExplosion(x,y,c) { for(let i=0;i<15;i++) particles.push(new Particle(x,y,c)); }

    function loop() {
        requestAnimationFrame(loop);
        const pads = navigator.getGamepads ? navigator.getGamepads() : [];

        if (!gameActive) {
            // P1 Kontrol
            if (pads[0]) {
                uiElements.p1.card.classList.add('active');
                uiElements.p1.name.innerText = getControllerType(pads[0]) === 'ps' ? "PLAYSTATION KOLU" : "XBOX KOLU";
                uiElements.p1.prompt.classList.add('show');
                updateIcons(0, getControllerType(pads[0]));
            } else {
                uiElements.p1.card.classList.remove('active');
                uiElements.p1.name.innerText = "KOL BEKLENİYOR...";
                uiElements.p1.prompt.classList.remove('show');
            }

            // P2 Kontrol
            if (pads[1]) {
                uiElements.p2.card.classList.add('active-p2');
                uiElements.p2.name.innerText = getControllerType(pads[1]) === 'ps' ? "PLAYSTATION KOLU" : "XBOX KOLU";
                uiElements.p2.prompt.classList.add('show');
                updateIcons(1, getControllerType(pads[1]));
            } else {
                uiElements.p2.card.classList.remove('active-p2');
                uiElements.p2.name.innerText = "KOL BEKLENİYOR...";
                uiElements.p2.prompt.classList.remove('show');
            }

            if (pads[0] && pads[1]) {
                if (pads[0].buttons[0].pressed || pads[1].buttons[0].pressed) {
                    gameActive = true;
                    uiElements.startScreen.style.display = 'none';
                    // Oyun içi ikonları da güncelle
                    updateIcons(0, getControllerType(pads[0]));
                    updateIcons(1, getControllerType(pads[1]));
                }
            }
            return;
        }

        // OYUN
        ctx.fillStyle = "#050505"; ctx.fillRect(0,0,canvas.width, canvas.height);
        if(shakeTime>0) { ctx.save(); ctx.translate((Math.random()-0.5)*15,(Math.random()-0.5)*15); shakeTime--; }
        
        ctx.strokeStyle="#111"; ctx.lineWidth=2; ctx.beginPath();
        for(let x=0;x<canvas.width;x+=50){ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);}
        for(let y=0;y<canvas.height;y+=50){ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);} ctx.stroke();

        if(pads[0]) players[0].update(pads[0]); if(pads[1]) players[1].update(pads[1]);

        // Revive Logic
        [0,1].forEach(i=>{
            let me=players[i], other=players[i===0?1:0];
            if(me.isDead && !other.isDead && Math.hypot(me.x-other.x,me.y-other.y)<60) {
                me.reviveProgress+=1.5;
                if(me.reviveProgress>=100) { me.isDead=false; me.lives=2; me.reviveProgress=0; me.invulnerableTime=180; createExplosion(me.x,me.y,'#00ff00'); shakeTime=20; }
            } else me.reviveProgress=0;
        });

        shockwaves.forEach((s,i)=>{ if(s.active){s.update();s.draw();}else shockwaves.splice(i,1); });
        players[0].draw(); players[1].draw();

        spawnTimer++; if(spawnTimer>spawnRate){enemies.push(new Enemy()); spawnTimer=0; if(spawnRate>10)spawnRate-=0.05;}

        for(let i=bullets.length-1;i>=0;i--){
            let b=bullets[i]; b.update(); b.draw();
            if(b.x<0||b.x>canvas.width||b.y<0||b.y>canvas.height){bullets.splice(i,1);continue;}
            for(let j=enemies.length-1;j>=0;j--){
                let e=enemies[j];
                if(Math.hypot(b.x-e.x,b.y-e.y)<e.r+4){
                    createExplosion(e.x,e.y,e.c); enemies.splice(j,1); bullets.splice(i,1);
                    if(b.c===P1_COLOR)players[0].score+=10;else players[1].score+=10; break;
                }
            }
        }
        for(let i=enemies.length-1;i>=0;i--){
            let e=enemies[i]; e.update(); e.draw();
            players.forEach(p=>{
                if(!p.isDead && p.invulnerableTime<=0 && Math.hypot(p.x-e.x,p.y-e.y)<p.radius+e.r){
                    p.takeDamage(); createExplosion(e.x,e.y,e.c); enemies.splice(i,1);
                }
            });
        }
        particles.forEach((p,i)=>{p.update();p.draw();if(p.life<=0)particles.splice(i,1);});

        if(shakeTime>0) ctx.restore();
        uiElements.p1.score.innerText = `P1: ${players[0].score}`;
        uiElements.p2.score.innerText = `P2: ${players[1].score}`;
        
        if(players[0].isDead && players[1].isDead) {
            ctx.fillStyle="rgba(0,0,0,0.8)"; ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle="white"; ctx.font="bold 60px Orbitron"; ctx.textAlign="center"; ctx.fillText("OYUN BİTTİ",canvas.width/2,canvas.height/2);
            ctx.font="20px Orbitron"; ctx.fillText("Yeniden başlamak için F5",canvas.width/2,canvas.height/2+60);
        }
    }
    loop();
    window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
</script>
</body>
</html>
