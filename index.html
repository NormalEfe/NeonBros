<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Neon Bros: Final Fixed</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');

        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Orbitron', sans-serif; }
        canvas { display: block; }
        
        /* --- TUŞ İKONLARI --- */
        .btn {
            display: inline-flex; justify-content: center; align-items: center;
            width: 28px; height: 28px; border-radius: 50%; 
            margin: 0 5px; position: relative; vertical-align: middle;
            box-shadow: 0 3px 0 rgba(0,0,0,0.5); font-family: Arial, sans-serif; font-weight: bold;
        }
        .xbox-a { background: #1a1a1a; color: greenyellow; border: 2px solid #414040; font-size: 16px; }
        .xbox-x { background: #1a1a1a; color: rgb(27, 109, 216); border: 2px solid #414040; font-size: 16px; }
        .xbox-menu { border-radius: 5px; width: 50px; background: #1a1a1a; border: 2px solid #414040; font-size: 10px; color:white; }

        .ps-cross { background: #1a1a1a; border: 2px solid #414040; }
        .ps-cross::after { content: '✕'; color: #4b8ac4; font-size: 16px; font-weight: bold; }
        .ps-square { background: #1a1a1a; border: 2px solid #414040; }
        .ps-square::after { content: ''; display: block; width: 10px; height: 10px; border: 3px solid #d856ac; border-radius: 2px; }
        .ps-opt { border-radius: 10px; width: 50px; background: #1a1a1a; border: 2px solid #414040; font-size: 10px; color:white; }

        /* --- UI KATMANI --- */
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        .top-bar { display: flex; justify-content: space-between; padding: 20px 50px; text-shadow: 0 0 10px currentColor; font-size: 24px; font-weight: bold; }
        #p1-score { color: #00f7ff; }
        #p2-score { color: #ffaa00; }

        #wave-hud { position: absolute; top: 80px; width: 100%; text-align: center; color: white; text-shadow: 0 0 15px rgba(255,255,255,0.5); transition: 0.3s; }
        .wave-title { font-size: 32px; font-weight: 900; letter-spacing: 2px; color: #ff0055; margin-bottom: 5px; }
        .wave-info { font-size: 18px; color: #aaa; }
        .wave-break { color: #00ff00; font-size: 24px; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .bottom-bar { display: flex; justify-content: space-between; padding: 20px 50px; align-items: end; }
        .ulti-container { width: 300px; text-align: left; opacity: 0.9; }
        .ulti-label { color: white; font-size: 14px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .ulti-bar-bg { width: 100%; height: 12px; background: #222; border: 2px solid #444; border-radius: 6px; overflow: hidden; }
        .ulti-bar-fill { height: 100%; width: 0%; transition: width 0.1s linear; box-shadow: 0 0 15px currentColor; }
        
        /* EKRANLAR */
        #start-screen, #pause-screen, #gameover-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; z-index: 10; pointer-events: auto;
        }
        #start-screen { background: radial-gradient(circle, rgba(10,10,20,0.98) 0%, #000 100%); }
        #pause-screen { background: rgba(0, 0, 0, 0.85); display: none; z-index: 20; pointer-events: none; }
        #gameover-screen { background: rgba(0, 0, 0, 0.95); display: none; z-index: 30; }

        h1 { font-size: 70px; margin: 0; letter-spacing: 5px; background: linear-gradient(to right, #00f7ff, #ffffff, #ffaa00); -webkit-background-clip: text; color: transparent; text-shadow: 0 0 30px rgba(255,255,255,0.3); }

        .status-area { margin-top: 50px; display: flex; gap: 40px; }
        .player-card {
            background: rgba(255,255,255,0.05); padding: 20px 40px; border-radius: 10px; border: 1px solid #333;
            text-align: center; width: 200px; transition: 0.3s;
        }
        .player-card.connected { border-color: #555; background: rgba(255,255,255,0.1); }
        .player-card.ready { border-color: #00ff00; background: rgba(0, 255, 0, 0.1); box-shadow: 0 0 20px rgba(0, 255, 0, 0.2); transform: scale(1.05); }

        .con-name { font-size: 12px; color: #888; margin-top: 5px; }
        .start-prompt { margin-top: 15px; font-size: 14px; opacity: 0.5; }
        .ready-text { font-size: 18px; font-weight: bold; color: #00ff00; margin-top: 10px; display: none; }
        .player-card.ready .ready-text { display: block; }
        .player-card.ready .start-prompt { display: none; }

        .score-detail { font-size: 30px; margin-top: 20px; color: #fff; font-weight: bold; }
        .score-sub { font-size: 16px; color: #aaa; margin-top: 5px; }

    </style>
</head>
<body>

    <div id="pause-screen">
        <h1 style="font-size: 50px;">DURAKLATILDI</h1>
        <div style="margin-top: 20px; font-size: 18px; color: #aaa;">Devam: <b>MENÜ</b></div>
    </div>

    <div id="gameover-screen">
        <h1 style="font-size: 60px;">OYUN BİTTİ</h1>
        
        <div id="total-score-display" class="score-detail">TOPLAM PUAN: 0</div>
        <div id="final-wave-display" class="score-sub">ULAŞILAN DALGA: 1</div>

        <div style="margin-top: 50px; font-size: 14px; color: #888; display:flex; align-items:center; gap:10px;">
            MENÜYE DÖNMEK İÇİN <span class="btn xbox-menu">MENU</span> / <span class="btn ps-opt">OPT</span> BASIN
        </div>
    </div>

    <div id="ui">
        <div class="top-bar">
            <span id="p1-score">P1: 0</span>
            <div id="wave-hud">
                <div id="wave-title" class="wave-title">DALGA 1</div>
                <div id="wave-info" class="wave-info">Düşmanlar Geliyor...</div>
            </div>
            <span id="p2-score">P2: 0</span>
        </div>
        
        <div class="bottom-bar">
            <div class="ulti-container">
                <div class="ulti-label">
                    <span id="p1-ulti-icon" class="btn"></span> ULTİ <span id="p1-ulti-text" style="color:#00f7ff; font-size:10px; margin-left:auto;">HAZIR!</span>
                </div>
                <div class="ulti-bar-bg"><div id="p1-ulti-bar" class="ulti-bar-fill" style="background:#00f7ff; width:100%;"></div></div>
            </div>
            <div class="ulti-container" style="text-align:right;">
                <div class="ulti-label" style="justify-content: flex-end;">
                    <span id="p2-ulti-text" style="color:#ffaa00; font-size:10px; margin-right:auto;">HAZIR!</span> ULTİ <span id="p2-ulti-icon" class="btn"></span>
                </div>
                <div class="ulti-bar-bg"><div id="p2-ulti-bar" class="ulti-bar-fill" style="background:#ffaa00; width:100%;"></div></div>
            </div>
        </div>
    </div>

    <div id="start-screen">
        <h1>NEON BROS</h1>
        <div style="font-size: 14px; letter-spacing: 5px; color: #666; margin-bottom: 40px;">ULTIMATE EDITION</div>

        <div class="status-area">
            <div id="p1-card" class="player-card">
                <div style="font-size:20px; font-weight:bold; color:#00f7ff;">OYUNCU 1</div>
                <div id="p1-con-name" class="con-name">KOL YOK</div>
                <div id="p1-prompt" class="start-prompt"><span id="p1-start-icon" class="btn"></span> BAS</div>
                <div class="ready-text">HAZIR</div>
            </div>

            <div id="p2-card" class="player-card">
                <div style="font-size:20px; font-weight:bold; color:#ffaa00;">OYUNCU 2</div>
                <div id="p2-con-name" class="con-name">KOL YOK</div>
                <div id="p2-prompt" class="start-prompt"><span id="p2-start-icon" class="btn"></span> BAS</div>
                <div class="ready-text">HAZIR</div>
            </div>
        </div>
        <div style="margin-top:30px; font-size:12px; color:#555;">(Her İki Oyuncu Hazır Olduğunda Başlar)</div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // --- HTML ELEMENTLERİ ---
    const ui = {
        p1: {
            card: document.getElementById('p1-card'),
            name: document.getElementById('p1-con-name'),
            startIcon: document.getElementById('p1-start-icon'),
            ultiIcon: document.getElementById('p1-ulti-icon'),
            ultiBar: document.getElementById('p1-ulti-bar'),
            ultiText: document.getElementById('p1-ulti-text'),
            score: document.getElementById('p1-score')
        },
        p2: {
            card: document.getElementById('p2-card'),
            name: document.getElementById('p2-con-name'),
            startIcon: document.getElementById('p2-start-icon'),
            ultiIcon: document.getElementById('p2-ulti-icon'),
            ultiBar: document.getElementById('p2-ulti-bar'),
            ultiText: document.getElementById('p2-ulti-text'),
            score: document.getElementById('p2-score')
        },
        waveTitle: document.getElementById('wave-title'),
        waveInfo: document.getElementById('wave-info'),
        startScreen: document.getElementById('start-screen'),
        pauseScreen: document.getElementById('pause-screen'),
        gameoverScreen: document.getElementById('gameover-screen'),
        totalScoreDisplay: document.getElementById('total-score-display'),
        finalWaveDisplay: document.getElementById('final-wave-display')
    };

    // --- AYARLAR ---
    const P1_COLOR = '#00f7ff';
    const P2_COLOR = '#ffaa00';
    let gameActive = false;
    let isGameOver = false;
    let isPaused = false;
    let shakeTime = 0;
    
    let lastPauseToggle = 0;
    let p1Ready = false;
    let p2Ready = false;
    let p1BtnLast = false;
    let p2BtnLast = false;

    // Wave Değişkenleri
    let currentWave = 1;
    let waveEnemiesTotal = 0;
    let waveEnemiesKilled = 0;
    let waveEnemiesSpawned = 0;
    let isWaveBreak = false;
    let waveBreakTimer = 0;
    let spawnTimer = 0;
    let spawnRate = 60;

    function getControllerType(gamepad) {
        if (!gamepad) return 'xbox';
        const id = gamepad.id.toLowerCase();
        if (id.includes('sony') || id.includes('dual') || id.includes('054c') || id.includes('playstation')) return 'ps';
        return 'xbox';
    }

    function updateIcons(playerId, type) {
        const p = playerId === 0 ? ui.p1 : ui.p2;
        p.startIcon.className = 'btn'; p.startIcon.innerText = ''; 
        p.ultiIcon.className = 'btn'; p.ultiIcon.innerText = ''; 
        if (type === 'ps') {
            p.startIcon.classList.add('ps-cross');
            p.ultiIcon.classList.add('ps-square');
        } else {
            p.startIcon.classList.add('xbox-a'); p.startIcon.innerText = 'A';
            p.ultiIcon.classList.add('xbox-x'); p.ultiIcon.innerText = 'X';
        }
    }

    // --- OYUN SINIFLARI ---
    class Shockwave {
        constructor(x, y, color) {
            this.x=x; this.y=y; this.color=color; this.r=10; this.speed=15; this.active=true; this.lw=10; this.alpha=1;
        }
        update() {
            this.r+=this.speed; this.lw*=0.95; this.alpha-=0.03; if(this.alpha<=0)this.active=false;
            for(let i=enemies.length-1; i>=0; i--){
                let e = enemies[i];
                if(Math.abs(Math.hypot(e.x-this.x, e.y-this.y)-this.r)<30){
                    createExplosion(e.x,e.y,e.c); enemies.splice(i,1); waveEnemiesKilled++;
                }
            }
        }
        draw() {
            ctx.save(); ctx.beginPath(); ctx.arc(this.x,this.y,this.r,0,Math.PI*2);
            ctx.strokeStyle=this.color; ctx.lineWidth=this.lw; ctx.globalAlpha=this.alpha;
            ctx.shadowBlur=20; ctx.shadowColor=this.color; ctx.stroke(); ctx.restore();
        }
    }

    class Player {
        constructor(id, color) {
            this.id=id; this.color=color; this.reset();
        }
        reset() {
            this.x=canvas.width/2+(this.id===0?-100:100); this.y=canvas.height/2;
            this.r=20; this.speed=6; this.lives=2; this.isDead=false; this.invulnerableTime=0;
            this.reviveProgress=0; this.score=0; this.lastShot=0; this.lastUlti=0;
        }
        update(gamepad) {
            if(this.isDead) return;
            if(this.invulnerableTime>0) this.invulnerableTime--;
            this.x += (Math.abs(gamepad.axes[0])>0.1?gamepad.axes[0]:0)*this.speed;
            this.y += (Math.abs(gamepad.axes[1])>0.1?gamepad.axes[1]:0)*this.speed;
            this.constrain();
            
            let ax=Math.abs(gamepad.axes[2])>0.1?gamepad.axes[2]:0, ay=Math.abs(gamepad.axes[3])>0.1?gamepad.axes[3]:0;
            if(ax!==0||ay!==0){
                this.aimAngle=Math.atan2(ay,ax);
                if(Date.now()-this.lastShot>100){
                    bullets.push(new Bullet(this.x,this.y,this.aimAngle,this.color));
                    this.lastShot=Date.now(); this.x-=Math.cos(this.aimAngle)*2; this.y-=Math.sin(this.aimAngle)*2;
                }
            }
            if(gamepad.buttons[2].pressed) this.triggerUlti();
            this.updateUI();
        }
        triggerUlti() {
            if(Date.now()-this.lastUlti>20000) {
                this.lastUlti=Date.now(); shockwaves.push(new Shockwave(this.x,this.y,this.color)); shakeTime=30;
            }
        }
        updateUI() {
            let passed=Date.now()-this.lastUlti, pct=Math.min((passed/20000)*100,100);
            if(this.lastUlti===0) pct=100;
            const u = this.id===0?ui.p1:ui.p2;
            u.ultiBar.style.width=pct+"%";
            if(pct>=100){
                u.ultiBar.style.backgroundColor=this.color; u.ultiBar.style.boxShadow=`0 0 10px ${this.color}`;
                u.ultiText.innerText="HAZIR!"; u.ultiText.style.opacity=1;
            } else {
                u.ultiBar.style.backgroundColor="#555"; u.ultiBar.style.boxShadow="none";
                u.ultiText.innerText=Math.ceil((20000-passed)/1000)+"sn"; u.ultiText.style.opacity=0.5;
            }
        }
        constrain() {
            if(this.x<this.r)this.x=this.r; if(this.x>canvas.width-this.r)this.x=canvas.width-this.r;
            if(this.y<this.r)this.y=this.r; if(this.y>canvas.height-this.r)this.y=canvas.height-this.r;
        }
        takeDamage() {
            if(this.invulnerableTime>0||this.isDead) return;
            this.lives--; shakeTime=10;
            if(this.lives<=0) { this.isDead=true; createExplosion(this.x,this.y,this.color); }
            else { this.invulnerableTime=120; createExplosion(this.x,this.y,"#fff"); }
        }
        draw() {
            if(this.isDead){
                ctx.save(); ctx.globalAlpha=0.3; ctx.strokeStyle=this.color; ctx.lineWidth=2;
                ctx.beginPath(); ctx.arc(this.x,this.y,this.r,0,Math.PI*2); ctx.stroke();
                ctx.font="12px Orbitron"; ctx.fillStyle="white"; ctx.textAlign="center"; ctx.fillText("KURTAR",this.x,this.y-35);
                if(this.reviveProgress>0){ctx.fillStyle="#00ff00";ctx.fillRect(this.x-20,this.y+35,(this.reviveProgress/100)*40,5);}
                ctx.restore(); return;
            }
            if(this.invulnerableTime>0 && Math.floor(Date.now()/50)%2===0)return;
            ctx.save(); ctx.shadowBlur=15; ctx.shadowColor=this.color; ctx.fillStyle=this.color;
            ctx.beginPath(); ctx.arc(this.x,this.y,this.r,0,Math.PI*2); ctx.fill();
            ctx.shadowBlur=0; ctx.strokeStyle="rgba(255,255,255,0.5)"; ctx.lineWidth=2;
            ctx.beginPath(); ctx.moveTo(this.x,this.y); ctx.lineTo(this.x+Math.cos(this.aimAngle)*40,this.y+Math.sin(this.aimAngle)*40); ctx.stroke();
            ctx.font="14px Arial"; ctx.fillStyle="#ff3333"; ctx.textAlign="center";
            let h=""; for(let i=0;i<this.lives;i++)h+="❤"; ctx.fillText(h,this.x,this.y-30);
            ctx.fillStyle="#000"; ctx.font="bold 10px Orbitron"; ctx.textBaseline="middle"; ctx.fillText(this.id===0?"P1":"P2",this.x,this.y); ctx.restore();
        }
    }

    class Bullet {
        constructor(x,y,a,c){this.x=x+Math.cos(a)*20;this.y=y+Math.sin(a)*20;this.vx=Math.cos(a)*15;this.vy=Math.sin(a)*15;this.c=c;}
        update(){this.x+=this.vx;this.y+=this.vy;}
        draw(){ctx.save();ctx.shadowBlur=10;ctx.shadowColor=this.c;ctx.fillStyle="white";ctx.beginPath();ctx.arc(this.x,this.y,4,0,Math.PI*2);ctx.fill();ctx.restore();}
    }
    class Enemy {
        constructor(wave){
            let sb=(wave-1)*0.15;
            if(Math.random()<0.5){this.x=Math.random()<0.5?-30:canvas.width+30;this.y=Math.random()*canvas.height;}
            else{this.x=Math.random()*canvas.width;this.y=Math.random()<0.5?-30:canvas.height+30;}
            this.r=15; this.s=(Math.random()*2+1)+sb; this.c='#ff0044';
        }
        update(){
            let t=null, d1=players[0].isDead?Infinity:Math.hypot(players[0].x-this.x,players[0].y-this.y), d2=players[1].isDead?Infinity:Math.hypot(players[1].x-this.x,players[1].y-this.y);
            if(d1===Infinity&&d2===Infinity)return;
            t=d1<d2?players[0]:players[1];
            let a=Math.atan2(t.y-this.y,t.x-this.x); this.x+=Math.cos(a)*this.s; this.y+=Math.sin(a)*this.s;
        }
        draw(){ctx.save();ctx.shadowBlur=10;ctx.shadowColor=this.c;ctx.fillStyle=this.c;ctx.fillRect(this.x-this.r,this.y-this.r,this.r*2,this.r*2);ctx.restore();}
    }
    class Particle{constructor(x,y,c){this.x=x;this.y=y;this.vx=(Math.random()-0.5)*10;this.vy=(Math.random()-0.5)*10;this.life=1;this.c=c;}update(){this.x+=this.vx;this.y+=this.vy;this.life-=0.04;}draw(){ctx.save();ctx.globalAlpha=this.life;ctx.fillStyle=this.c;ctx.beginPath();ctx.arc(this.x,this.y,3,0,Math.PI*2);ctx.fill();ctx.restore();}}

    const players=[new Player(0,P1_COLOR),new Player(1,P2_COLOR)];
    let bullets=[], enemies=[], particles=[], shockwaves=[];

    function createExplosion(x,y,c){for(let i=0;i<15;i++)particles.push(new Particle(x,y,c));}

    function startWave(waveNum) {
        currentWave = waveNum; isWaveBreak = false;
        waveEnemiesTotal = 5 + (waveNum * 3); 
        waveEnemiesKilled = 0; waveEnemiesSpawned = 0;
        spawnRate = Math.max(10, 60 - (waveNum * 2));
        ui.waveTitle.innerText = "DALGA " + waveNum;
        ui.waveInfo.className = "wave-info";
        ui.waveInfo.innerText = "Kalan: " + waveEnemiesTotal;
    }

    function startWaveBreak() {
        isWaveBreak=true; waveBreakTimer=20; 
        ui.waveTitle.innerText="DALGA TAMAMLANDI!"; ui.waveInfo.className="wave-break";
    }

    function togglePause() {
        isPaused=!isPaused; ui.pauseScreen.style.display=isPaused?'flex':'none';
    }

    function resetToMenu() {
        gameActive = false; isGameOver = false; isPaused = false;
        p1Ready = false; p2Ready = false;
        ui.p1.card.classList.remove('ready'); ui.p2.card.classList.remove('ready');
        ui.gameoverScreen.style.display = 'none';
        ui.startScreen.style.display = 'flex';
        bullets=[]; enemies=[]; particles=[]; shockwaves=[];
        players[0].reset(); players[1].reset();
    }

    function loop() {
        requestAnimationFrame(loop);
        const pads = navigator.getGamepads ? navigator.getGamepads() : [];

        // --- MENÜ MANTIĞI ---
        if (!gameActive) {
            if(pads[0]){
                ui.p1.card.classList.add('connected'); ui.p1.name.innerText=getControllerType(pads[0])==='ps'?"PS KOLU":"XBOX KOLU";
                updateIcons(0, getControllerType(pads[0]));
                if(pads[0].buttons[0].pressed && !p1BtnLast) { p1Ready=!p1Ready; ui.p1.card.classList.toggle('ready'); }
                p1BtnLast = pads[0].buttons[0].pressed;
            } else { ui.p1.card.classList.remove('connected','ready'); p1Ready=false; ui.p1.name.innerText="KOL YOK"; }

            if(pads[1]){
                ui.p2.card.classList.add('connected'); ui.p2.name.innerText=getControllerType(pads[1])==='ps'?"PS KOLU":"XBOX KOLU";
                updateIcons(1, getControllerType(pads[1]));
                if(pads[1].buttons[0].pressed && !p2BtnLast) { p2Ready=!p2Ready; ui.p2.card.classList.toggle('ready'); }
                p2BtnLast = pads[1].buttons[0].pressed;
            } else { ui.p2.card.classList.remove('connected','ready'); p2Ready=false; ui.p2.name.innerText="KOL YOK"; }

            let p1OK = !pads[0] || p1Ready; 
            let p2OK = !pads[1] || p2Ready;
            let atLeastOne = pads[0] || pads[1];

            if(atLeastOne && p1OK && p2OK) {
                gameActive=true; ui.startScreen.style.display='none'; startWave(1);
            }
            return;
        }

        // --- PAUSE / RESTART CHECK ---
        const startBtn = (pads[0] && pads[0].buttons[9].pressed) || (pads[1] && pads[1].buttons[9].pressed);
        if(startBtn && Date.now()-lastPauseToggle>300) {
            if(isGameOver) resetToMenu(); 
            else togglePause(); 
            lastPauseToggle=Date.now();
        }

        if(isPaused || isGameOver) {
            if(isGameOver && ui.gameoverScreen.style.display==='none') {
                 ui.gameoverScreen.style.display='flex';
                 ui.finalWaveDisplay.innerText = "ULAŞILAN DALGA: " + currentWave;
                 ui.totalScoreDisplay.innerText = "TOPLAM PUAN: " + (players[0].score + players[1].score);
            }
            return; 
        }

        // --- OYUN ÇİZİMİ ---
        ctx.fillStyle = "#050505"; ctx.fillRect(0,0,canvas.width, canvas.height);
        if(shakeTime>0) { ctx.save(); ctx.translate((Math.random()-0.5)*15,(Math.random()-0.5)*15); shakeTime--; }
        ctx.strokeStyle="#111"; ctx.lineWidth=2; ctx.beginPath();
        for(let x=0;x<canvas.width;x+=50){ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);}
        for(let y=0;y<canvas.height;y+=50){ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);} ctx.stroke();

        if(pads[0]) players[0].update(pads[0]); if(pads[1]) players[1].update(pads[1]);

        if(!isWaveBreak) {
            if (waveEnemiesSpawned < waveEnemiesTotal) {
                spawnTimer++;
                if(spawnTimer > spawnRate) {
                    enemies.push(new Enemy(currentWave)); spawnTimer=0; waveEnemiesSpawned++;
                }
            } else if (enemies.length === 0) {
                startWaveBreak();
            }
            ui.waveInfo.innerText = "Kalan: " + (waveEnemiesTotal - waveEnemiesKilled);
        } else {
            if(spawnTimer%60===0) {
                waveBreakTimer--; ui.waveInfo.innerText="SONRAKİ DALGA: "+waveBreakTimer+"sn";
                if(waveBreakTimer<=0) startWave(currentWave+1);
            }
            spawnTimer++;
        }

        [0,1].forEach(i=>{
            let me=players[i], other=players[i===0?1:0];
            if(me.isDead && !other.isDead && Math.hypot(me.x-other.x,me.y-other.y)<60) {
                me.reviveProgress+=1.5;
                if(me.reviveProgress>=100) { me.isDead=false; me.lives=2; me.reviveProgress=0; me.invulnerableTime=180; createExplosion(me.x,me.y,'#00ff00'); shakeTime=20; }
            } else me.reviveProgress=0;
        });

        shockwaves.forEach((s,i)=>{if(s.active){s.update();s.draw();}else shockwaves.splice(i,1);});
        players[0].draw(); players[1].draw();

        for(let i=bullets.length-1;i>=0;i--){
            let b=bullets[i]; b.update(); b.draw();
            if(b.x<0||b.x>canvas.width||b.y<0||b.y>canvas.height){bullets.splice(i,1);continue;}
            for(let j=enemies.length-1;j>=0;j--){
                let e=enemies[j];
                if(Math.hypot(b.x-e.x,b.y-e.y)<e.r+4){
                    createExplosion(e.x,e.y,e.c); enemies.splice(j,1); bullets.splice(i,1); waveEnemiesKilled++;
                    if(b.c===P1_COLOR)players[0].score+=10;else players[1].score+=10; break;
                }
            }
        }
        
        // --- DÜZELTİLEN KISIM: Çarpışma Mantığı ---
        for(let i=enemies.length-1;i>=0;i--){
            let e=enemies[i]; e.update(); e.draw();
            for(let j=0; j<players.length; j++){
                let p = players[j];
                // 'p.r' kullanıyoruz, 'p.radius' DEĞİL
                if(!p.isDead && p.invulnerableTime<=0 && Math.hypot(p.x-e.x,p.y-e.y)<p.r+e.r){
                    p.takeDamage(); 
                    createExplosion(e.x,e.y,e.c); 
                    enemies.splice(i,1); 
                    waveEnemiesKilled++;
                    break;
                }
            }
        }
        
        particles.forEach((p,i)=>{p.update();p.draw();if(p.life<=0)particles.splice(i,1);});
        if(shakeTime>0) ctx.restore();
        ui.p1.score.innerText = `P1: ${players[0].score}`; ui.p2.score.innerText = `P2: ${players[1].score}`;
        
        if(players[0].isDead && players[1].isDead) isGameOver=true;
    }
    loop();
    window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
</script>
</body>
</html>
